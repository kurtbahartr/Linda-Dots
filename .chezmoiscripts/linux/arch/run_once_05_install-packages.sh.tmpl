#!/bin/bash
set -e

# Detect installed AUR helper
AUR_HELPER=""
for helper in yay paru trizen; do
  if command -v "$helper" &>/dev/null; then
    AUR_HELPER="$helper"
    break
  fi
done

install_packages() {
  local pacman_pkgs=($1)
  local aur_pkgs=($2)
  local flatpak_pkgs=($3)

  # -------------------
  # Pacman packages
  # -------------------
  to_install=()
  for pkg in "${pacman_pkgs[@]}"; do
    if ! pacman -Qq "$pkg" &>/dev/null; then
      to_install+=("$pkg")
    else
      echo "Package $pkg is already installed, skipping."
    fi
  done
  if [ ${#to_install[@]} -gt 0 ]; then
    sudo pacman -S --noconfirm "${to_install[@]}"
  fi

  # -------------------
  # AUR packages
  # -------------------
  if [ -n "$AUR_HELPER" ]; then
    to_install_aur=()
    for pkg in "${aur_pkgs[@]}"; do
      if ! pacman -Qq "$pkg" &>/dev/null; then
        to_install_aur+=("$pkg")
      else
        echo "AUR package $pkg is already installed, skipping."
      fi
    done
    if [ ${#to_install_aur[@]} -gt 0 ]; then
      $AUR_HELPER -S --noconfirm "${to_install_aur[@]}"
    fi
  elif [ ${#aur_pkgs[@]} -gt 0 ]; then
    echo "No AUR helper installed, skipping AUR packages: ${aur_pkgs[*]}"
  fi

  # -------------------
  # Flatpak packages
  # -------------------
  for pkg in "${flatpak_pkgs[@]}"; do
    if ! flatpak list | grep -q "^$pkg"; then
      flatpak install -y flathub "$pkg"
    else
      echo "Flatpak app $pkg is already installed, skipping."
    fi
  done
}

# ----------------------------
# 1. Flatpak packages section
# ----------------------------
{{- if .config.flatpak }}
install_packages \
  "{{ join " " .flatpak_packages.pacman }}" \
  "{{ join " " .flatpak_packages.aur }}" \
  "{{ join " " .flatpak_packages.flatpak }}"
{{- end }}

# ----------------------------
# 2. Hyprland packages
# ----------------------------
{{- if .config.ui_environment.hyprland }}
install_packages \
  "{{ join " " .hyprland.pacman }}" \
  "{{ join " " .hyprland.aur }}" \
  ""
{{- end }}

# ----------------------------
# 3. Service packages
# ----------------------------

{{- if .config.system.bluetooth.enable }}
install_packages \
  "{{ join " " .bluetooth.pacman }}" \
  "{{ join " " .bluetooth.aur }}" \
  ""
{{- end }}

{{- if .config.system.audio.pipewire.enable }}
install_packages \
  "{{ join " " .pipewire.pacman }}" \
  "{{ join " " .pipewire.aur }}" \
  ""
{{- end }}

# ----------------------------
# 4. QEMU packages
# ----------------------------
{{- if .config.qemu.enable }}
install_packages \
  "{{ join " " .kvm_packages.pacman }}" \
  "{{ join " " .kvm_packages.aur }}" \
  ""
{{- end }}

{{- if .config.qemu.virt_manager }}
install_packages \
  "{{ join " " .virt_manager_packages.pacman }}" \
  "{{ join " " .virt_manager_packages.aur }}" \
  ""
{{- end }}

# ----------------------------
# 5. Extra fonts
# ----------------------------
{{- if .config.extra_fonts }}
install_packages \
  "{{ join " " .font_packages.pacman }}" \
  "{{ join " " .font_packages.aur }}" \
  ""
{{- end }}

# ----------------------------
# 6. fcitx5 packages
# ----------------------------
{{- if .config.fcitx5 }}
fcitx5_pkgs=()
for pkg in {{ join " " .fcitx5_packages.pacman }}; do
  fcitx5_pkgs+=("$pkg")
done
install_packages \
  "${fcitx5_pkgs[*]}" \
  "" \
  ""
{{- end }}

# ----------------------------
# 6. Gaming packages
# ----------------------------
{{- if .config.gaming }}
gaming_pkgs=()
for pkg in {{ join " " .gaming_packages.pacman }}; do
  {{- if not .config.multilib }}
  if [[ "$pkg" == lib32-* ]]; then continue; fi
  {{- end }}
  gaming_pkgs+=("$pkg")
done
install_packages \
  "${gaming_pkgs[*]}" \
  "{{ join " " .gaming_packages.aur }}" \
  ""
{{- end }}

# ----------------------------
# 7. School packages
# ----------------------------
{{- if .config.school }}
install_packages \
  "{{ join " " .school_packages.pacman }}" \
  "{{ join " " .school_packages.aur }}" \
  ""
{{- end }}

# ----------------------------
# 8. Language servers
# ----------------------------
{{- if .language_servers }}
install_packages \
  "{{ join " " .language_servers.packages }}" \
  "{{ join " " .language_servers.aur }}" \
  ""
{{- end }}

# ----------------------------
# 9. Additional packages
# ----------------------------
{{- if .packages.pacman }}
install_packages \
  "{{ join " " .packages.pacman }}" \
  "{{ join " " .packages.aur }}" \
  ""
{{- end }}

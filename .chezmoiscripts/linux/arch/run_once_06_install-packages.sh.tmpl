#!/bin/bash
set -uo pipefail

export MAKEFLAGS="-j$(nproc)"

# Detect AUR helper
AUR_HELPER=""
for helper in paru yay trizen; do
  if command -v "$helper" &>/dev/null; then
    AUR_HELPER="$helper"
    break
  fi
done

if [[ -n "$AUR_HELPER" ]]; then
  echo "Using AUR helper: $AUR_HELPER"
else
  echo "Warning: No AUR helper found (paru, yay, or trizen)"
fi

ALL_PACMAN_PKGS=()
ALL_AUR_PKGS=()
ALL_FLATPAK_PKGS=()

add_packages() {
  [[ -n "$1" ]] && ALL_PACMAN_PKGS+=($1)
  [[ -n "$2" ]] && ALL_AUR_PKGS+=($2)
  [[ -n "$3" ]] && ALL_FLATPAK_PKGS+=($3)
}

# ============================================
# Collect packages from configuration
# ============================================

{{- if .config.system.packages.flatpak }}
add_packages \
  "{{ join " " .packages.system.flatpak.pacman }}" \
  "{{ join " " .packages.system.flatpak.aur }}" \
  "{{ join " " .packages.system.flatpak.flatpak }}"
{{- end }}

{{- if .config.system.bluetooth.enable }}
add_packages \
  "{{ join " " .packages.system.bluetooth.pacman }}" \
  "{{ join " " .packages.system.bluetooth.aur }}" \
  "{{ join " " .packages.system.bluetooth.flatpak }}"
{{- end }}

{{- if .config.system.audio.pipewire.enable }}
add_packages \
  "{{ join " " .packages.system.pipewire.pacman }}" \
  "{{ join " " .packages.system.pipewire.aur }}" \
  "{{ join " " .packages.system.pipewire.flatpak }}"
{{- end }}

{{- if .config.system.printing.enable }}
add_packages \
  "{{ join " " .packages.system.printing.pacman }}" \
  "{{ join " " .packages.system.printing.aur }}" \
  "{{ join " " .packages.system.printing.flatpak }}"
{{- end }}

{{- if .config.desktop_stack.command_line_shell.zsh.enable }}
add_packages \
  "{{ join " " .packages.desktop_stack.command_line_shell_zsh.pacman }}" \
  "{{ join " " .packages.desktop_stack.command_line_shell_zsh.aur }}" \
  "{{ join " " .packages.desktop_stack.command_line_shell_zsh.flatpak }}"
{{- end }}

{{- if .config.system.packages.command_utils }}
add_packages \
  "{{ join " " .packages.system.command_utils.pacman }}" \
  "{{ join " " .packages.system.command_utils.aur }}" \
  "{{ join " " .packages.system.command_utils.flatpak }}"
{{- end }}

add_packages \
  "{{ join " " .packages.desktop_stack.desktop_stack_common.pacman }}" \
  "{{ join " " .packages.desktop_stack.desktop_stack_common.aur }}" \
  "{{ join " " .packages.desktop_stack.desktop_stack_common.flatpak }}"

{{- if .config.desktop_stack.window_managers.hyprland.enable }}
add_packages \
  "{{ join " " .packages.desktop_stack.hyprland.pacman }}" \
  "{{ join " " .packages.desktop_stack.hyprland.aur }}" \
  "{{ join " " .packages.desktop_stack.hyprland.flatpak }}"
{{- end }}

{{- if .config.desktop_stack.themeing }}
add_packages \
  "{{ join " " .packages.desktop_stack.themeing.pacman }}" \
  "{{ join " " .packages.desktop_stack.themeing.aur }}" \
  "{{ join " " .packages.desktop_stack.themeing.flatpak }}"
{{- end }}

{{- if .config.qemu.enable }}
add_packages \
  "{{ join " " .packages.qemu.kvm.pacman }}" \
  "{{ join " " .packages.qemu.kvm.aur }}" \
  "{{ join " " .packages.qemu.kvm.flatpak }}"
{{- end }}

{{- if .config.qemu.virt_manager }}
add_packages \
  "{{ join " " .packages.qemu.virt_manager.pacman }}" \
  "{{ join " " .packages.qemu.virt_manager.aur }}" \
  "{{ join " " .packages.qemu.virt_manager.flatpak }}"
{{- end }}

{{- if .config.system.packages.extra_fonts }}
add_packages \
  "{{ join " " .packages.system.font.pacman }}" \
  "{{ join " " .packages.system.font.aur }}" \
  "{{ join " " .packages.system.font.flatpak }}"
{{- end }}

{{- if .config.system.packages.fcitx5 }}
add_packages \
  "{{ join " " .packages.system.fcitx5.pacman }}" \
  "{{ join " " .packages.system.fcitx5.aur }}" \
  "{{ join " " .packages.system.fcitx5.flatpak }}"
{{- end }}

{{- if .config.system.packages.gaming }}
gaming_pkgs=""
for pkg in {{ join " " .packages.system.gaming.pacman }}; do
  {{- if not .config.system.arch.multilib }}
  [[ "$pkg" == lib32-* ]] && continue
  {{- end }}
  gaming_pkgs+="$pkg "
done
add_packages \
  "$gaming_pkgs" \
  "{{ join " " .packages.system.gaming.aur }}" \
  "{{ join " " .packages.system.gaming.flatpak }}"
{{- end }}

{{- if .config.system.packages.school }}
add_packages \
  "{{ join " " .packages.system.school.pacman }}" \
  "{{ join " " .packages.system.school.aur }}" \
  "{{ join " " .packages.system.school.flatpak }}"
{{- end }}

{{- if .packages.system.language_servers }}
add_packages \
  "{{ join " " .packages.system.language_servers.pacman }}" \
  "{{ join " " .packages.system.language_servers.aur }}" \
  "{{ join " " .packages.system.language_servers.flatpak }}"
{{- end }}

{{- if .packages.system.user_packages }}
add_packages \
  "{{ join " " .packages.system.user_packages.pacman }}" \
  "{{ join " " .packages.system.user_packages.aur }}" \
  "{{ join " " .packages.system.user_packages.flatpak }}"
{{- end }}

# ----------------------------
# Install everything at once
# ----------------------------

readarray -t ALL_PACMAN_PKGS < <(printf '%s\n' "${ALL_PACMAN_PKGS[@]}" | grep -v '^$' | sort -u)
readarray -t ALL_AUR_PKGS < <(printf '%s\n' "${ALL_AUR_PKGS[@]}" | grep -v '^$' | sort -u)
readarray -t ALL_FLATPAK_PKGS < <(printf '%s\n' "${ALL_FLATPAK_PKGS[@]}" | grep -v '^$' | sort -u)

if [ ${#ALL_PACMAN_PKGS[@]} -gt 0 ]; then
  echo "Installing ${#ALL_PACMAN_PKGS[@]} pacman packages..."
  sudo pacman -S --needed --noconfirm "${ALL_PACMAN_PKGS[@]}"
fi

if [ -n "$AUR_HELPER" ] && [ ${#ALL_AUR_PKGS[@]} -gt 0 ]; then
  echo "Installing ${#ALL_AUR_PKGS[@]} AUR packages..."
  "$AUR_HELPER" -S --needed --noconfirm "${ALL_AUR_PKGS[@]}"
fi

if [ ${#ALL_FLATPAK_PKGS[@]} -gt 0 ]; then
  echo "Installing ${#ALL_FLATPAK_PKGS[@]} Flatpak packages..."
  flatpak install -y --noninteractive flathub "${ALL_FLATPAK_PKGS[@]}" 2>/dev/null ||
    for pkg in "${ALL_FLATPAK_PKGS[@]}"; do
      flatpak install -y --noninteractive flathub "$pkg" 2>/dev/null || true
    done
fi

#!/bin/bash
set -e

{{- if .config.system.arch.aur_wrapper }}

AUR_HELPER="{{ .config.system.arch.aur_wrapper }}"

# Binary name = remove '-' and everything after it
AUR_CMD="${AUR_HELPER%-*}"

echo "Configured AUR helper package: $AUR_HELPER"
echo "Checking for installed command: $AUR_CMD"

# Check if helper command is already available
if command -v "$AUR_CMD" &>/dev/null; then
  echo "$AUR_CMD is already installed."
  exit 0
fi

echo "Installing AUR helper: $AUR_HELPER"

# Ensure required dependencies
sudo pacman -S --noconfirm --needed git base-devel

AUR_DIR="$HOME/.aur_builds"
mkdir -p "$AUR_DIR"
cd "$AUR_DIR"

rm -rf "$AUR_HELPER"

git clone "https://aur.archlinux.org/${AUR_HELPER}.git"
cd "$AUR_HELPER"

makepkg -si --noconfirm

echo "$AUR_CMD installed successfully."

# Cleanup
rm -rf "$HOME/.aur_builds"

{{- end }}

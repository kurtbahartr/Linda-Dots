#!/bin/bash
set -e

{{- if .packages.aur }}

AUR_HELPER="{{ .config.system.arch.aur_wrapper }}"

# Binary name = remove '-' and everything after it
AUR_CMD="${AUR_HELPER%-*}"

echo "Configured AUR helper package: $AUR_HELPER"
echo "Checking for installed command: $AUR_CMD"

# Check if helper command is already available
if command -v "$AUR_CMD" &>/dev/null; then
  echo "$AUR_CMD is already installed."
  exit 0
fi

echo "Installing AUR helper: $AUR_HELPER"

# Ensure required dependencies
for pkg in git base-devel; do
  if ! pacman -Qq "$pkg" &>/dev/null; then
    echo "Installing dependency: $pkg"
    sudo pacman -S --noconfirm --needed "$pkg"
  fi
done

AUR_DIR="$HOME/.aur_builds"
mkdir -p "$AUR_DIR"
cd "$AUR_DIR"

rm -rf "$AUR_HELPER"

git clone "https://aur.archlinux.org/${AUR_HELPER}.git"
cd "$AUR_HELPER"

makepkg -si --noconfirm

echo "$AUR_CMD installed successfully."

# Cleanup
echo "Cleaning up AUR build directory..."
rm -rf "$HOME/.aur_builds"

{{- end }}

#!/usr/bin/env bash
set -e

drivers_to_install=()

# Cache lsmod output once
LSMOD_OUTPUT=$(lsmod)

# Helper to check if module is loaded
module_loaded() {
  grep -q "$1" <<<"$LSMOD_OUTPUT"
}

# ----------------------------
# Mesa (core) â€” always install
# ----------------------------
drivers_to_install+=(mesa)
{{ if .config.system.arch.multilib -}}
drivers_to_install+=(lib32-mesa)
{{ end -}}

# ----------------------------
# AMD GPU drivers
# ----------------------------
{{ if .config.drivers.amd -}}
if module_loaded amdgpu; then
  drivers_to_install+=(vulkan-radeon vulkan-icd-loader)
  {{ if .config.system.arch.multilib -}}
  drivers_to_install+=(lib32-vulkan-radeon lib32-vulkan-icd-loader)
  {{ end -}}
else
  echo "No amdgpu module loaded, skipping AMD Vulkan drivers."
fi
{{ end -}}

# ----------------------------
# NVIDIA GPU drivers
# ----------------------------
{{ if .config.drivers.nvidia.enable -}}
if module_loaded nouveau; then
  {{ if .config.drivers.nvidia.prefer_open -}}
  drivers_to_install+=(nvidia-open)
  {{ else -}}
  drivers_to_install+=(nvidia)
  {{ end -}}
else
  echo "No nouveau module loaded, skipping NVIDIA drivers."
fi
{{ end -}}

# ----------------------------
# Intel GPU drivers
# ----------------------------
{{ if .config.drivers.intel -}}
if grep -qE 'i915|xe' <<<"$LSMOD_OUTPUT"; then
  drivers_to_install+=(vulkan-intel vulkan-icd-loader)
  {{ if .config.system.arch.multilib -}}
  drivers_to_install+=(lib32-vulkan-intel lib32-vulkan-icd-loader)
  {{ end -}}
else
  echo "No i915/xe module loaded, skipping Intel Vulkan drivers."
fi
{{ end -}}

# ----------------------------
# KVM guest drivers
# ----------------------------
{{ if .config.drivers.kvm_guest -}}
drivers_to_install+=(qemu-guest-agent spice-vdagent)
{{ end -}}

# ----------------------------
# Install all drivers
# ----------------------------
if [ ${#drivers_to_install[@]} -eq 0 ]; then
  echo "No driver packages to install."
else
  # Remove duplicates
  readarray -t drivers_to_install < <(printf '%s\n' "${drivers_to_install[@]}" | sort -u)

  echo "Installing ${#drivers_to_install[@]} driver packages..."
  sudo pacman -S --needed --noconfirm "${drivers_to_install[@]}"
fi

#!/bin/bash
set -e

enable_services() {
  local mode="$1"
  local services=($2)
  local label="$3"

  local cmd="systemctl"
  [[ "$mode" == "user" ]] && cmd="systemctl --user"

  to_enable=()

  for srv in "${services[@]}"; do
    unit="${srv}.service"
    # Single check: is-enabled returns non-zero for disabled AND non-existent
    status=$($cmd is-enabled "$unit" 2>/dev/null) || status="not-found"

    case "$status" in
      enabled | static | indirect)
        echo "$unit already enabled"
        ;;
      not-found)
        echo "$unit not found, skipping"
        ;;
      *)
        to_enable+=("$unit")
        ;;
    esac
  done

  # Batch enable ALL services in single call
  if [ ${#to_enable[@]} -gt 0 ]; then
    echo "Enabling ${#to_enable[@]} ${label} services: ${to_enable[*]}"
    $cmd enable --now "${to_enable[@]}"
  else
    echo "No ${label} services to enable."
  fi
}

{{- if .config.system.features.bluetooth.enable }}
enable_services system "{{ join " " .services.system.bluetooth }}" "bluetooth"
{{- end }}

{{- if .config.system.features.printing.enable }}
enable_services system "{{ join " " .services.system.printing }}" "cups"
{{- end }}

{{- if .config.system.features.audio.pipewire.enable }}
enable_services user "{{ join " " .services.user.audio.pipewire }}" "pipewire"
{{- end }}

{{- if .config.system.packages.gaming }}
enable_services user "{{ join " " .services.system.gaming }}" "gaming (gamemode)"
{{- end }}

{{- if .config.system.virtualization.qemu.enable }}
enable_services system "{{ join " " .kvm_services.system }}" "KVM"
{{- end }}

{{- if eq .config.desktop_stack.login_manager "ly" }}
enable_services system "{{ join " " .services.system.login_manager.ly }}" "login manager (ly)"
{{- end }}
